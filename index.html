<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
<meta name="google-site-verification" content="X9qZORBLBnGwFWDuw6baR04BpaaHBP4HS1bZpxoC7cU" />
<meta name="baidu-site-verification" content="code-6P2d6Gqyrr" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"jerchenxin.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Xin CHEN&#39;s Homepage">
<meta property="og:url" content="http://jerchenxin.github.io/index.html">
<meta property="og:site_name" content="Xin CHEN&#39;s Homepage">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Xin CHEN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://jerchenxin.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Xin CHEN's Homepage</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Xin CHEN's Homepage</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jerchenxin.github.io/2021/05/27/Disk-%E6%9D%82%E8%B0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xin CHEN">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xin CHEN's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/27/Disk-%E6%9D%82%E8%B0%88/" class="post-title-link" itemprop="url">Disk 杂谈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-05-27 11:33:20 / Modified: 15:13:38" itemprop="dateCreated datePublished" datetime="2021-05-27T11:33:20+08:00">2021-05-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hardware/" itemprop="url" rel="index"><span itemprop="name">hardware</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Magnetic-Disk"><a href="#Magnetic-Disk" class="headerlink" title="Magnetic Disk"></a>Magnetic Disk</h1><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p><img src="../img/disk-md-struct.png"><br>上图为磁盘结构，可以看到由多个platter绕着中间的spindle以及用于读写的read-write head构成。</p>
<p>每个platter由很多同心圆环track组成，<strong>从外到内</strong>由0开始编号，第0磁道、第1磁道…每个磁道由多个sector组成，可以看到外圈的track含有的sector会比内圈的多。</p>
<p>磁盘的最小单元即为sector，由512个字节组成。</p>
<h2 id="读写方式"><a href="#读写方式" class="headerlink" title="读写方式"></a>读写方式</h2><ul>
<li>读</li>
</ul>
<p>首先<strong>磁盘的物理地址</strong>由三个部分组成，柱面号、磁头号、扇区号。</p>
<p>所以当一个读请求进来的时候，需要先定位到相应的驻面，因为磁盘有很多磁头，然后需要选择一个正确的磁头，接着在这个track中找到想要读区的sector。</p>
<p>总结一下：</p>
<ol>
<li>先定位到驻面（即定位到所有同半径的tracks）</li>
<li>在这些tracks中选择一个track（即选择哪个磁头进行读取）</li>
<li>接着在这个track中选择一个sector进行读取。</li>
</ol>
<p>上述步骤，第一步则为寻道时间（seek time），第三步则为旋转延迟时间（rotational latency time）</p>
<ul>
<li>写</li>
</ul>
<p>写文件的顺序：<strong>柱面、磁头、扇区</strong>。</p>
<p>具体来讲：</p>
<ol>
<li>从最外的驻面开始写（比如1号驻面开始，写满后，然后再2号、3号、…，直到所有驻面写满，磁盘就写满了）</li>
<li>从这个驻面的从上到下的磁道开始写（选择一个驻面后，先写1号盘面的track，再写2号盘面，…，直到这个驻面的所有track被写满）</li>
<li>对于每个track，在sector上连续写数据</li>
</ol>
<p>知道怎么写数据后，再思考下，假如一个文件占据很多个驻面，怎么顺序读完整个文件？（假设存储时绝对顺序，一共有n个盘面）</p>
<p>大致步骤：找到对应的最外层驻面（seek 1次），磁头转n次把同一个驻面的所有盘面读完（这里不需要再次seek了），最近seek到下一个驻面，同上操作。这就是顺序读取为什么特别快的原因，因为几乎都在转圈圈，seek的次数很少。</p>
<p>不过实际没这么理想，主要是因为没有这么大的连续空间，所有会有很多磁盘碎片产生。</p>
<ul>
<li>随机读写</li>
</ul>
<p>明白磁盘的读写方式之后，可以看到磁盘的随机读写会特别慢。比如一个range query进来，里面的元素都随机分布在磁盘的各个位置，此时需要很多次seek，所以导致磁盘的随机读写效率特别低。</p>
<h1 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h1><p>使用磁盘时，大部分时间消耗都在机械部件的动作上（seek），真正传输数据其实是特别快的。SSD用集成电路代替旋转磁盘，所以SSD速度会比磁盘快很多。</p>
<h2 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h2><p><img src="../img/disk-ssd-struct.png"></p>
<p>如上图所示，这个并不是完整的SSD，只拎出比较重要的Block、Page来描述SSD。</p>
<p>一个SSD有很多闪存（Flash）组成，每个闪存有很多Block，每个Block有很多Page，每个Page大小为4K或者8K。</p>
<p><img src="../img/disk-ssd-table.png"></p>
<p>为了快速定位一个page在哪里，SSD通过上述的LBA MapTable来做一个逻辑地址和物理地址（物理Page）的映射，这也是SSD的seek时间快的原因。</p>
<h2 id="读写方式-1"><a href="#读写方式-1" class="headerlink" title="读写方式"></a>读写方式</h2><ul>
<li>读</li>
</ul>
<p>SSD的读，在上面已经讲的差不多了。注意的是，SSD的读是以一个Page为单位的。</p>
<p>步骤：</p>
<ol>
<li>通过LBA MapTable找到Page</li>
<li>直接读这个Page的内容</li>
</ol>
<ul>
<li>写</li>
</ul>
<p>SSD的写挺有意思的，涉及到垃圾回收机制。</p>
<p>首先Flash有以下两个性质：</p>
<ol>
<li>写必须以Page为单位，而且不能覆盖有内容的Page（一个Page可能逻辑上被删除，但是里面的内容还未被清空），只能写在一个空白的Page上</li>
<li>擦除数据的时候，必须以一个Block为单位</li>
</ol>
<p>接下来介绍2种写，第一种是直接写（即写入新的数据），第二种是修改原有的数据。</p>
<p><img src="../img/disk-ssd-write.png"></p>
<p>上图为直接写，首先page分为3种，第一种是有效（即有数据并且这个数据被某个文件引用着），第二种是空闲（即空白page），第三种是无效（即有数据，但是没有被文件引用，比如逻辑上调用delete file这个操作）。直接写需要找到一个空闲page进行写。</p>
<p><img src="../img/disk-ssd-update.png"></p>
<p>上图为覆盖写（update）。由于Flash的特性不能覆盖原有的Page，所以需要找到一个空闲的page把修改的内容写入，然后把原有的page设置有无效（修改LBA MapTable的内容）</p>
<h2 id="垃圾回收机制"><a href="#垃圾回收机制" class="headerlink" title="垃圾回收机制"></a>垃圾回收机制</h2><p>首先介绍一个概念，over-provisioning，指的是SSD的实际存储空间比可写入的空间要大。比如，一块可用容量为500G的SSD，实际空间可能有512G，平常咱们买SSD的时候，其实就已经可以观察到标注的容量都不是2的指数倍，其实就因为over-provisioning的存在。那为什么需要将512G中的12G单独拿出来呢？这个12G在垃圾回收时起着copy的作用，这也是“擦除数据的时候，必须以一个Block为单位”的影响。</p>
<p>从上个章节的SSD写的步骤，可以看到无效的Page会随着写操作的增加而增加，所以需要使用垃圾回收机制定期把一些无效Page清空。</p>
<p><img src="../img/disk-ssd-gc.png"></p>
<p>上图为垃圾回收（GC）的演示图，大致步骤是：</p>
<ol>
<li>在over-provisioning中找到一个空的block</li>
<li>将block0的ABCDEFH和block1的A复制到这个block</li>
<li>擦除block0</li>
<li>把block1的BCDEFH复制到block0，此时block0就有两个空闲page了</li>
<li>擦除block1</li>
</ol>
<h2 id="SSD存在的问题"><a href="#SSD存在的问题" class="headerlink" title="SSD存在的问题"></a>SSD存在的问题</h2><p>首先SSD的GC操作会使得block被疯狂擦写，然而block是有寿命的，不能超过一定的擦写次数。</p>
<p>其次，在上面的GC操作中，我们可以看到，其实block0和block1的正确的数据都被重写了一遍，导致了<strong>写放大</strong>问题。顺便介绍一下写放大这个概念，在数据库中会经常听到的一个概念。</p>
<ul>
<li><strong>写放大</strong>，即本身数据大小为n，理论上在硬盘中只需要被写入n大小的数据，但是由于一些附加操作，导致这些相同的数据被写入了多次，导致实际写入了k*n这么多数据。有很多方式会导致写放大，比如SSD的GC，或者平常数据库为了一致性而需要写日志（日志中包括数据）。关于减少写放大，也是一个research的研究方向。</li>
</ul>
<p>然后，ssd的写放大除了GC的时候，当update的时候也会出现。因为比如只需要update一个page中很小一块的数据，但是需要把整个page都copy并且重写一遍，所以这个也导致了写放大问题。之后我可能会写文章介绍LSM-tree，介绍从软件层面解决这个问题的方法。</p>
<h1 id="NVMe"><a href="#NVMe" class="headerlink" title="NVMe"></a>NVMe</h1><p>之后再单独写写NVMe，现在有很多research都在研究NVMe，之后不懒的时候打算整理下NVMe的研究进展。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://jerchenxin.github.io/2021/05/24/Intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xin CHEN">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xin CHEN's Homepage">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/24/Intro/" class="post-title-link" itemprop="url">Intro</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-05-24 17:06:24" itemprop="dateCreated datePublished" datetime="2021-05-24T17:06:24+08:00">2021-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-05-27 11:36:41" itemprop="dateModified" datetime="2021-05-27T11:36:41+08:00">2021-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Self-Intro/" itemprop="url" rel="index"><span itemprop="name">Self-Intro</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Xin-CHEN"><a href="#Xin-CHEN" class="headerlink" title="Xin CHEN"></a>Xin CHEN</h2><h3 id="PhD"><a href="#PhD" class="headerlink" title="PhD"></a>PhD</h3><p>Rm 512, William M.W. Mong Engineering Building<br>Dept. of Systems Engineering and Engineering Management<br>The Chinese University of Hong Kong<br>Shatin, N.T., Hong Kong</p>
<h3 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h3><p>jerchenxin at gmail dot com</p>
<h3 id="Biography"><a href="#Biography" class="headerlink" title="Biography"></a>Biography</h3><p>I am a first year PhD student in the Chinese University of Hong Kong (<strong>CUHK</strong>), supervised by Prof. Sibo Wang. I received my B.E. in Software Engineering at Zhejiang University (<strong>ZJU</strong>) in 2020. </p>
<h3 id="Research-Interest"><a href="#Research-Interest" class="headerlink" title="Research Interest"></a>Research Interest</h3><p>Database &amp; System</p>
<h3 id="Publications"><a href="#Publications" class="headerlink" title="Publications"></a>Publications</h3><p>A breakthrough is on the way.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xin CHEN</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xin CHEN</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='34,34,34' opacity='0.5' zIndex='-1' count='200' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
